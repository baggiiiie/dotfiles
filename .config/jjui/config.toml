[preview]
file_command = [
    "diff",
    "--color",
    "always",
    "-r",
    "$change_id",
    "--config",
    "ui.diff-formatter=delta-non-split-view",
    "$file",
]
position = "auto"
revision_command = [
    "show",
    "--color",
    "always",
    "-r",
    "$change_id",
    "--config",
    "ui.diff-formatter=delta-non-split-view",
]
width_percentage = 60.0


[suggest]
[suggest.exec]
mode = "fuzzy"

[ui]
auto_refresh_interval = 30
enable_mouse = true
mouse_events = true

[ui.colors]
[ui.colors.selected]
bg = "#575048"
bold = true

[[actions]]
name = "create_pr"
lua = '''
local change_id = context.change_id()
if not change_id then
    flash("No revision selected")
    return
end

local template = 'if(self.present() && !remote, self.name() ++ "\n", "")'
local output = jj("bookmark", "list", "-r", change_id, "-T", template)
local bookmarks = {}
for line in output:gmatch("[^\n]+") do
    if line ~= "" then
        table.insert(bookmarks, line)
    end
end

local cmd = "/Users/ydai/Desktop/repos/personal/tries/2025-12-12-jj-git-integration/jj-create-pr.sh"
if #bookmarks > 0 then
    if #bookmarks > 1 then
        flash("Multiple bookmarks found, using: " .. bookmarks[1])
    end
    cmd = cmd .. " --branch " .. bookmarks[1]
end

exec_shell(cmd)

'''

[[bindings]]
action = "create_pr"
key = "ctrl+p"
scope = "revisions"
desc = "create_pr"
lua = '''
local change_id = context.change_id()
if not change_id then
    flash("No revision selected")
    return
end

local template = 'if(self.present() && !remote, self.name() ++ "\n", "")'
local output = jj("bookmark", "list", "-r", change_id, "-T", template)
local bookmarks = {}
for line in output:gmatch("[^\n]+") do
    if line ~= "" then
        table.insert(bookmarks, line)
    end
end

local cmd = "/Users/ydai/Desktop/repos/personal/tries/2025-12-12-jj-git-integration/jj-create-pr.sh"
if #bookmarks > 0 then
    if #bookmarks > 1 then
        flash("Multiple bookmarks found, using: " .. bookmarks[1])
    end
    cmd = cmd .. " --branch " .. bookmarks[1]
end

exec_shell(cmd)
'''

[[actions]]
name = "deltadiff"
lua = '''
jj_interactive("util", "exec", "--", "bash", "-c", "/Users/ydai/Desktop/repos/personal/dotfiles/.config/jj/jj-diffnav.sh -r " .. context.change_id())
'''

[[bindings]]
action = "deltadiff"
key = "d"
scope = "revisions"
desc = "deltadiff"

[[actions]]
name = "new_insert_after"
lua = '''
  jj("new", "-A", context.change_id())
  revisions.refresh()

  local new_change_id = jj("log", "-r", "@", "-T", "change_id.shortest()", "--no-graph")
  revisions.navigate{to=new_change_id}
  
'''

[[bindings]]
action = "new_insert_after"
key = "N"
scope = "revisions"
desc = "new_insert_after"

[[actions]]
name = "quick_revset"
lua = '''
local selected = choose({
    options = {
        "mine()",
        "all()",
        "trunk()..@",
        revset.default()
    },
    title = "Quick Revset"
})

if selected then
    revset.set(selected)
    flash("Revset: " .. selected)
end

'''

[[bindings]]
action = "quick_revset"
key = "ctrl+r"
scope = "revisions"
desc = "quick_revset"

[[actions]]
name = "scroll_to_center"
lua = '''
-- Center the currently selected revision on screen.
-- Adjust `half` to roughly half your terminal height.
local half = 15

local id = context.change_id()
if not id then return end

-- 1. Scroll viewport far down so cursor is above the visible area
revisions.scroll(100)
-- 2. Navigate back â€” ensureView snaps cursor to the top edge
revisions.navigate({ to = id })
-- 3. Scroll viewport up to push cursor from top toward center
revisions.scroll(-half)

'''

[[bindings]]
action = "scroll_to_center"
key = "Z"
scope = "revisions"
desc = "scroll_to_center"
